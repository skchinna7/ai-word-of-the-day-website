<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding -->
    <meta charset="UTF-8">
    <!-- Viewport for responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title><!-- Page title (also in <title>) -->
    <meta name="title" content="Word of the Day - Learn New Words Daily">
    <!-- Page description for search engines -->
    <meta name="description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <!-- Keywords (less important now) -->
    <meta name="keywords" content="word of the day, vocabulary, learning, english words, dictionary">
    <!-- Author -->
    <meta name="author" content="Your Name or Organization">
    <!-- Robots directive -->
    <meta name="robots" content="index, follow">
    <!-- Open Graph protocol -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.wotd.in/">
    <meta property="og:title" content="Word of the Day - Learn New Words Daily">
    <meta property="og:description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <meta property="og:image" content="https://www.wotd.in/images/logo.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourwebsite.com/">
    <meta name="twitter:title" content="Word of the Day - Learn New Words Daily">
    <meta name="twitter:description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <meta name="twitter:image" content="https://yourwebsite.com/images/logo.jpg">

        <!-- Prevent XSS attacks -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self';">

    <!-- Cache control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" type="image/jpg" href="images/logo.jpg">
    <link rel="icon" type="image/jpg" href="images/logo.jpg" sizes="32x32">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="canonical" href="https://www.wotd.in/index/">
    <link rel="alternate" hreflang="es" href="https://www.wotd.in/es/">
    <link rel="alternate" hreflang="fr" href="https://www.wotd.in/fr/">
</head>
<body>
    <div id="notLoggedIn" class="denied" style="display:none;">
        <h1>üîê Login Required</h1>
        <p>You must be logged in as admin to access this page.</p>
        <p style="margin-top: 20px;">
            <a href="login.html">Login</a> | <a href="index.html">Go Home</a>
        </p>
    </div>

    <div id="adminPanel" style="display:none;">
        <h1>üéõÔ∏è Admin Panel</h1>
        <div class="user-info">
            <div>
                Logged in as: <strong id="userEmail">Loading...</strong>
            </div>
            <div>
                <a href="index.html" style="margin-right: 10px;">‚Üê Home</a>
                <button onclick="logout()" style="padding: 8px 16px;">Logout</button>
                <img src="images/logo.jpg" alt="Word of the Day Logo" class="logo-image">
            </div>
        </div>
        
        <div class="form-container">
            <h2 id="formTitle">Add New Word</h2>
            <form id="wordForm">
                <input type="hidden" id="editId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Word *</label>
                        <input type="text" id="word" required>
                        <button type="button" class="btn-secondary" onclick="fetchPhonetics()" style="margin-top: 10px; width: 100%;">
                            üîä Auto-Get Phonetics
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Scheduled Date *</label>
                        <input type="date" id="scheduled" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Phonetic (e.g., /s…ôÀàr…õnd…™p…™ti/)</label>
                        <input type="text" id="phonetic" placeholder="Will auto-fill when you click button above">
                    </div>
                    
                    <div class="form-group">
                        <label>Pronunciation (e.g., ser-en-dip-i-ty)</label>
                        <input type="text" id="pronunciation" placeholder="Will auto-fill when you click button above">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Meaning *</label>
                    <textarea id="meaning" required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" id="submitBtn">Add Word</button>
                    <button type="button" class="btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display: none;">Cancel</button>
                </div>
            </form>
            <div id="msg" style="display:none"></div>
        </div>
        
        <div class="table-container">
            <h2>All Words</h2>
            <div id="list">Loading...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = window.supabase.createClient(
            "https://qzatavslhtkioivemwlk.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6YXRhdnNsaHRraW9pdmVtd2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzIyMTYsImV4cCI6MjA4NjEwODIxNn0.LaNyj8T6VYGMMbuyX-Fg_6Fm6yIhPLTW0enYd6sNdGE",
            {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true
                }
            }
        );
        
        let isEditing = false;
        
        async function checkAuth() {
            const { data: { session } } = await sb.auth.getSession();
            
            if (!session) {
                document.getElementById('notLoggedIn').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
                return false;
            }
            
            document.getElementById('notLoggedIn').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('userEmail').textContent = session.user.email;
            return true;
        }
        
        async function logout() {
            await sb.auth.signOut();
            window.location.href = 'index.html';
        }
        
        // Fetch phonetics from Free Dictionary API
        async function fetchPhonetics() {
            const wordInput = document.getElementById('word').value.trim();
            const phoneticInput = document.getElementById('phonetic');
            const pronunciationInput = document.getElementById('pronunciation');
            const msg = document.getElementById('msg');
            
            if (!wordInput) {
                msg.textContent = '‚ö†Ô∏è Please enter a word first';
                msg.className = 'message info';
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                return;
            }
            
            try {
                msg.textContent = 'üîÑ Fetching phonetics...';
                msg.className = 'message info';
                msg.style.display = 'block';
                
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${wordInput}`);
                
                if (!response.ok) {
                    throw new Error('Word not found in dictionary');
                }
                
                const data = await response.json();
                
                if (data && data[0]) {
                    const entry = data[0];
                    
                    // Get phonetic
                    if (entry.phonetic) {
                        phoneticInput.value = entry.phonetic;
                    } else if (entry.phonetics && entry.phonetics[0] && entry.phonetics[0].text) {
                        phoneticInput.value = entry.phonetics[0].text;
                    }
                    
                    // Create pronunciation from phonetic
                    if (phoneticInput.value) {
                        const simplified = phoneticInput.value
                            .replace(/[\/\[\]]/g, '')
                            .replace(/Àà/g, '')
                            .replace(/Àå/g, '');
                        pronunciationInput.value = simplified;
                    }
                    
                    msg.textContent = '‚úÖ Phonetics loaded!';
                    msg.className = 'message success';
                    setTimeout(() => msg.style.display = 'none', 2000);
                } else {
                    throw new Error('No phonetic data available');
                }
            } catch (error) {
                console.error('Phonetics error:', error);
                msg.textContent = '‚ö†Ô∏è Could not fetch phonetics. Please enter manually.';
                msg.className = 'message info';
                setTimeout(() => msg.style.display = 'none', 3000);
            }
        }
        
        document.getElementById('wordForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const w = document.getElementById('word').value.trim();
            const m = document.getElementById('meaning').value.trim();
            const s = document.getElementById('scheduled').value;
            const phonetic = document.getElementById('phonetic').value.trim();
            const pronunciation = document.getElementById('pronunciation').value.trim();
            const editId = document.getElementById('editId').value;
            const msg = document.getElementById('msg');
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = isEditing ? 'Updating...' : 'Adding...';
            
            try {
                const wordData = {
                    word: w, 
                    meaning: m, 
                    scheduled_for: s,
                    phonetic: phonetic || null,
                    pronunciation: pronunciation || null
                };
                
                let error;
                
                if (isEditing && editId) {
                    // Update existing word
                    ({ error } = await sb.from('words').update(wordData).eq('id', editId));
                } else {
                    // Insert new word
                    ({ error } = await sb.from('words').insert(wordData));
                }
                
                if (error) throw error;
                
                msg.className = 'message success';
                msg.textContent = isEditing ? '‚úÖ Word updated!' : '‚úÖ Word added!';
                document.getElementById('wordForm').reset();
                document.getElementById('scheduled').valueAsDate = new Date();
                cancelEdit();
                loadWords();
                
            } catch (error) {
                console.error('Error:', error);
                msg.className = 'message error';
                msg.textContent = '‚ùå ' + error.message;
            }
            
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 4000);
            submitBtn.disabled = false;
            submitBtn.textContent = isEditing ? 'Update Word' : 'Add Word';
        };
        
        window.editWord = function(id) {
            sb.from('words').select('*').eq('id', id).single()
                .then(({ data, error }) => {
                    if (error) throw error;
                    
                    isEditing = true;
                    document.getElementById('formTitle').textContent = 'Edit Word';
                    document.getElementById('editId').value = data.id;
                    document.getElementById('word').value = data.word;
                    document.getElementById('meaning').value = data.meaning;
                    document.getElementById('scheduled').value = data.scheduled_for;
                    document.getElementById('phonetic').value = data.phonetic || '';
                    document.getElementById('pronunciation').value = data.pronunciation || '';
                    document.getElementById('submitBtn').textContent = 'Update Word';
                    document.getElementById('cancelBtn').style.display = 'inline-block';
                    
                    // Scroll to form
                    document.getElementById('wordForm').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    alert('Error loading word: ' + error.message);
                });
        };
        
        function cancelEdit() {
            isEditing = false;
            document.getElementById('formTitle').textContent = 'Add New Word';
            document.getElementById('editId').value = '';
            document.getElementById('wordForm').reset();
            document.getElementById('scheduled').valueAsDate = new Date();
            document.getElementById('submitBtn').textContent = 'Add Word';
            document.getElementById('cancelBtn').style.display = 'none';
        }
        
        async function loadWords() {
            try {
                const {data, error} = await sb
                    .from('words')
                    .select('*')
                    .order('scheduled_for', {ascending: false});
                
                if (error) throw error;
                
                const list = document.getElementById('list');
                
                if (!data || data.length === 0) {
                    list.innerHTML = '<p>No words yet</p>';
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                list.innerHTML = '<table><tr><th>Date</th><th>Word</th><th>Phonetic</th><th>Meaning</th><th>Actions</th></tr>' +
                    data.map(w => {
                        const isToday = w.scheduled_for === today;
                        return `<tr class="${isToday ? 'today-row' : ''}">
                            <td>${w.scheduled_for || 'N/A'} ${isToday ? '<b>(TODAY)</b>' : ''}</td>
                            <td><b>${w.word}</b>${w.pronunciation ? `<br><span style="font-size: 12px; color: #666;">${w.pronunciation}</span>` : ''}</td>
                            <td style="font-style: italic; color: #666;">${w.phonetic || '-'}</td>
                            <td>${w.meaning.substring(0, 80)}${w.meaning.length > 80 ? '...' : ''}</td>
                            <td>
                                <button class="btn-edit" onclick="editWord('${w.id}')">Edit</button>
                                <button class="btn-delete" onclick="deleteWord('${w.id}')">Delete</button>
                            </td>
                        </tr>`;
                    }).join('') +
                    '</table>';
                    
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('list').innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
            }
        }
        
        window.deleteWord = async (id) => {
            if (!confirm('Delete this word?')) return;
            
            try {
                const {error} = await sb.from('words').delete().eq('id', id);
                if (error) throw error;
                loadWords();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        };
        
        // Set today as default
        document.getElementById('scheduled').valueAsDate = new Date();
        
        // Initialize
        checkAuth().then(ok => { if(ok) loadWords(); });
    </script>
</body>
</html>