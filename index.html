<!DOCTYPE html>
<html>
<head>
    <!-- Character encoding -->
    <meta charset="UTF-8">
    <!-- Viewport for responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word of the Day - Learn New Words Daily</title>
    <meta name="title" content="Word of the Day - Learn New Words Daily">
    <!-- Page description for search engines -->
    <meta name="description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <!-- Keywords (less important now) -->
    <meta name="keywords" content="word of the day, vocabulary, learning, english words, dictionary">
    <!-- Author -->
    <meta name="author" content="Your Name or Organization">
    <!-- Robots directive -->
    <meta name="robots" content="index, follow">
    <!-- Open Graph protocol -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.wotd.in/">
    <meta property="og:title" content="Word of the Day - Learn New Words Daily">
    <meta property="og:description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <meta property="og:image" content="https://www.wotd.in/images/logo.jpg">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourwebsite.com/">
    <meta name="twitter:title" content="Word of the Day - Learn New Words Daily">
    <meta name="twitter:description" content="Discover a new word every day with definitions, examples, and pronunciation guides.">
    <meta name="twitter:image" content="https://yourwebsite.com/images/logo.jpg">
        <!-- Prevent XSS attacks -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self';">
    <!-- Cache control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">    
    <!-- Favicon -->
    <link rel="icon" type="image/jpg" href="images/logo.jpg">
    <link rel="icon" type="image/jpg" href="images/logo.jpg" sizes="32x32">
    <link rel="stylesheet" href="css/style.css">
    <link rel="canonical" href="https://www.wotd.in/index/">
    <link rel="alternate" hreflang="es" href="https://www.wotd.in/es/">
    <link rel="alternate" hreflang="fr" href="https://www.wotd.in/fr/">
</head>
<body class="dark">
    <div class="container">
        <!-- Header with Logo -->
        <div class="header">
            <a href="index.html" class="logo-container">
                <img src="images/logo.jpg" alt="Word of the Day Logo" class="logo-image">
                <div>
                    <div class="logo-text">Word of the Day</div>
                    <span class="logo-tagline">Expand your vocabulary daily</span>
                </div>
            </a>
            <div class="controls" id="headerControls">
                <a href="login.html" class="btn">üîê Login</a>
                <div class="theme-toggle" id="themeToggle"></div>
                <a href="archive.html" class="btn">üìö Archive</a>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-bar" id="searchBar" placeholder="üîç Search for a word...">
            <span class="search-icon">üîç</span>
        </div>

        <div class="search-results" id="searchResults"></div>

        <!-- Today's Word -->
        <div class="word-section" id="wordSection">
            <div class="word-card">
                <div class="word" id="word">Loading...</div>
                <div class="phonetic" id="phonetic"></div>
                <div class="pronunciation" id="pronunciation"></div>
                <div class="stats" id="stats"></div>
            </div>
            
            <div class="meaning-card">
                <div class="meaning" id="meaning"></div>
            </div>
        </div>

        <!-- Trending Words -->
        <div class="trending-section">
            <h2 class="section-title">üî• Trending Words</h2>
            
            <div class="trending-tabs">
                <div class="trending-tab active" onclick="switchTrending('week')">This Week</div>
                <div class="trending-tab" onclick="switchTrending('month')">This Month</div>
            </div>
            
            <div id="trendingWeek" class="trending-list active">
                <div id="weeklyTrending">Loading trending words...</div>
            </div>
            
            <div id="trendingMonth" class="trending-list">
                <div id="monthlyTrending">Loading trending words...</div>
            </div>
        </div>

        <!-- Previous Words -->
        <div class="previous-words-section">
            <h2 class="section-title">üìñ Previous Words</h2>
            <div class="words-grid" id="previousWords">
                Loading previous words...
            </div>
        </div>

        <!-- Newsletter Signup -->
        <div class="newsletter">
            <h2>üìß Get Daily Words in Your Inbox</h2>
            <p>Never miss a word! Subscribe to receive our word of the day via email.</p>
            <form class="newsletter-form" id="subscribeForm">
                <input 
                    type="email" 
                    class="newsletter-input" 
                    id="subscribeEmail"
                    placeholder="Enter your email" 
                    required
                >
                <button type="submit" class="newsletter-btn">Subscribe</button>
            </form>
            <div id="subscribeStatus" style="margin-top: 15px;"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2026 Word of the Day. All rights reserved.</p>
            <p>Expand your vocabulary, one word at a time.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        const SUPABASE_URL = "https://qzatavslhtkioivemwlk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6YXRhdnNsaHRraW9pdmVtd2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzIyMTYsImV4cCI6MjA4NjEwODIxNn0.LaNyj8T6VYGMMbuyX-Fg_6Fm6yIhPLTW0enYd6sNdGE";

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        let currentWord = null;
        let currentUser = null;

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.className = savedTheme;
        if (savedTheme === 'dark') themeToggle.classList.add('active');

        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.contains('dark');
            document.body.className = isDark ? 'light' : 'dark';
            themeToggle.classList.toggle('active');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        });

        // Check login status
        async function checkLoginStatus() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    return;
                }
                
                const controls = document.getElementById('headerControls');
                
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('User logged in:', currentUser.email);
                    
                    controls.innerHTML = `
                        <div class="user-badge">
                            <span>üë§</span>
                            <span>${currentUser.email}</span>
                        </div>
                        <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>
                        <button class="btn-logout" onclick="handleLogout()">Logout</button>
                        <div class="theme-toggle ${savedTheme === 'dark' ? 'active' : ''}" id="themeToggle"></div>
                        <a href="archive.html" class="btn">üìö Archive</a>
                    `;
                    
                    const newThemeToggle = document.getElementById('themeToggle');
                    newThemeToggle.addEventListener('click', () => {
                        const isDark = document.body.classList.contains('dark');
                        document.body.className = isDark ? 'light' : 'dark';
                        newThemeToggle.classList.toggle('active');
                        localStorage.setItem('theme', isDark ? 'light' : 'dark');
                    });
                }
            } catch (err) {
                console.error('Check login error:', err);
            }
        }

        window.handleLogout = async function() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out: ' + error.message);
            }
        };

        // Load today's word
        async function loadTodayWord() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                let { data: words } = await supabase
                    .from('words')
                    .select('*')
                    .eq('scheduled_for', today)
                    .limit(1);

                if (!words || words.length === 0) {
                    const { data: latest } = await supabase
                        .from('words')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    words = latest;
                }

                if (!words || words.length === 0) {
                    document.getElementById('word').textContent = 'No Words Yet';
                    document.getElementById('meaning').textContent = 'Check back soon!';
                    return;
                }

                currentWord = words[0];
                displayWord(currentWord);

                // Track view
                await supabase
                    .from('words')
                    .update({ views: (currentWord.views || 0) + 1 })
                    .eq('id', currentWord.id);
                
                // Track in trends table (if exists)
                try {
                    await supabase.rpc('track_word_view', { p_word_id: currentWord.id });
                } catch (e) {
                    console.log('Trend tracking skipped');
                }

            } catch (error) {
                console.error('Error loading word:', error);
            }
        }

        function displayWord(word) {
            document.getElementById('word').textContent = word.word;
            document.getElementById('phonetic').textContent = word.phonetic ? `/${word.phonetic}/` : '';
            document.getElementById('pronunciation').textContent = word.pronunciation || '';
            document.getElementById('meaning').textContent = word.meaning;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-item">üëÅÔ∏è ${word.views || 0} views</div>
                <div class="stat-item">‚ù§Ô∏è ${word.favorites_count || 0} favorites</div>
                <div class="stat-item">üí¨ ${word.comments_count || 0} comments</div>
            `;
        }

        // Load previous words
        async function loadPreviousWords() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data: words } = await supabase
                    .from('words')
                    .select('*')
                    .lt('scheduled_for', today)
                    .order('scheduled_for', { ascending: false })
                    .limit(6);
                
                const container = document.getElementById('previousWords');
                
                if (!words || words.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.6;">No previous words yet</p>';
                    return;
                }
                
                container.innerHTML = words.map(w => `
                    <div class="word-item">
                        <div class="word-item-title">${w.word}</div>
                        <div class="word-item-date">üìÖ ${new Date(w.scheduled_for).toLocaleDateString()}</div>
                        <div class="word-item-meaning">${w.meaning.substring(0, 100)}${w.meaning.length > 100 ? '...' : ''}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading previous words:', error);
            }
        }

        // Load trending words
        async function loadTrendingWords() {
            try {
                // Weekly trending (last 7 days)
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const { data: weeklyWords } = await supabase
                    .from('words')
                    .select('*')
                    .gte('scheduled_for', weekAgo.toISOString().split('T')[0])
                    .order('views', { ascending: false })
                    .limit(5);
                
                const weeklyContainer = document.getElementById('weeklyTrending');
                
                if (weeklyWords && weeklyWords.length > 0) {
                    weeklyContainer.innerHTML = weeklyWords.map((w, i) => `
                        <div class="trending-item">
                            <div class="trending-rank">#${i + 1}</div>
                            <div class="trending-content">
                                <div class="trending-word">${w.word}</div>
                                <div class="trending-stats">üëÅÔ∏è ${w.views || 0} views ‚Ä¢ üìÖ ${new Date(w.scheduled_for).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    weeklyContainer.innerHTML = '<p style="text-align: center; opacity: 0.6;">No data yet</p>';
                }
                
                // Monthly trending (last 30 days)
                const monthAgo = new Date();
                monthAgo.setDate(monthAgo.getDate() - 30);
                
                const { data: monthlyWords } = await supabase
                    .from('words')
                    .select('*')
                    .gte('scheduled_for', monthAgo.toISOString().split('T')[0])
                    .order('views', { ascending: false })
                    .limit(5);
                
                const monthlyContainer = document.getElementById('monthlyTrending');
                
                if (monthlyWords && monthlyWords.length > 0) {
                    monthlyContainer.innerHTML = monthlyWords.map((w, i) => `
                        <div class="trending-item">
                            <div class="trending-rank">#${i + 1}</div>
                            <div class="trending-content">
                                <div class="trending-word">${w.word}</div>
                                <div class="trending-stats">üëÅÔ∏è ${w.views || 0} views ‚Ä¢ üìÖ ${new Date(w.scheduled_for).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    monthlyContainer.innerHTML = '<p style="text-align: center; opacity: 0.6;">No data yet</p>';
                }
                
            } catch (error) {
                console.error('Error loading trending words:', error);
            }
        }

        // Switch trending tabs
        window.switchTrending = function(period) {
            document.querySelectorAll('.trending-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.trending-list').forEach(list => list.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (period === 'week') {
                document.getElementById('trendingWeek').classList.add('active');
            } else {
                document.getElementById('trendingMonth').classList.add('active');
            }
        };

        // Search functionality
        let searchTimeout;
        document.getElementById('searchBar').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => searchWords(query), 300);
        });

        async function searchWords(query) {
            try {
                const { data: words } = await supabase
                    .from('words')
                    .select('*')
                    .or(`word.ilike.%${query}%,meaning.ilike.%${query}%`);

                const resultsDiv = document.getElementById('searchResults');
                
                try {
                    await supabase
                        .from('search_history')
                        .insert({
                            search_query: query,
                            results_count: words?.length || 0
                        });
                } catch (e) {
                    console.log('Search logging skipped');
                }

                if (!words || words.length === 0) {
                    resultsDiv.innerHTML = '<p>No words found</p>';
                    resultsDiv.style.display = 'block';
                    return;
                }

                resultsDiv.innerHTML = `
                    <h3>Found ${words.length} word${words.length > 1 ? 's' : ''}</h3>
                    ${words.map(w => `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <strong style="font-size: 20px;">${w.word}</strong>
                            ${w.phonetic ? `<span style="color: #666; font-style: italic; margin-left: 10px;">/${w.phonetic}/</span>` : ''}
                            <p>${w.meaning}</p>
                        </div>
                    `).join('')}
                `;
                resultsDiv.style.display = 'block';

            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // Subscribe to newsletter
        document.getElementById('subscribeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('subscribeEmail').value.trim();
            const statusDiv = document.getElementById('subscribeStatus');

            try {
                const { error } = await supabase
                    .from('subscribers')
                    .insert({ email });

                if (error) {
                    if (error.code === '23505') {
                        statusDiv.textContent = 'You\'re already subscribed!';
                        statusDiv.style.color = '#ffeb3b';
                    } else {
                        throw error;
                    }
                } else {
                    statusDiv.textContent = '‚úÖ Subscribed! Check your email.';
                    statusDiv.style.color = '#fff';
                    document.getElementById('subscribeEmail').value = '';
                }

            } catch (error) {
                console.error('Subscribe error:', error);
                statusDiv.textContent = '‚ùå Error subscribing';
                statusDiv.style.color = '#f44336';
            }
        });

        // Initialize everything
        async function initializePage() {
            await checkLoginStatus();
            await loadTodayWord();
            await loadPreviousWords();
            await loadTrendingWords();
        }

        initializePage();
    </script>
</body>
</html>